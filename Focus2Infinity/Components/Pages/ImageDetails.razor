@page "/imagedetails"
@page "/imagedetails/{Topic}/{Name}"

@using System.Web
@using Focus2Infinity.Data
@using Focus2Infinity
@using Focus2Infinity.Options
@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Options
@inject F2IDataService f2iDataService
@inject IStringLocalizer<SharedResource> L
@inject IOptions<OverlayEditorOptions> OverlayEditorOptions

@rendermode InteractiveServer

@if (_headline != null)
{
  <h3 class="text-center my-5">@_headline</h3>
  <div class="row align-items-start">
    <div class="@ColSizeImg" style="position: relative; flex-shrink: 0; flex-grow: 0; align-self: flex-start;" @onmouseover="ShowOverlayImage" @onmouseout="HideOverlayImage">
      <div style="position: relative; display: inline-block; width: fit-content;">
        <img src="@ImgFile" alt="Image" style="max-width: 100%; height: auto; object-fit: contain; display: block;" />
        @if (_overlayData != null)
        {
          <Cmp_SvgOverlay OverlayData="_overlayData" ShowOverlay="_showOverlay" />
        }
        else if (_hasOverlayImg && _showOverlay)
        {
          @* Fallback to old JPG overlay for backward compatibility *@
          <img src="@OverlayImgFile" alt="Overlay" style="position: absolute; top: 0; left: 0; max-width: 100%; height: auto; object-fit: contain; pointer-events: none; z-index: 10;" />
        }
      </div>
    </div>
    <div class=@ColSizeTxt>
      @if (OverlayEditorOptions.Value.Enabled)
      {
        <p class="small mb-2">
          <a href="@EditOverlayUrl">Edit overlay</a>
        </p>
      }
      <Cmp_TextCard Topic=@Topic Src=@Name Details="true" HasOverlay="@(_hasOverlayImg || _overlayData != null)" />
    </div>
  </div>
}
else
{
  <p>@L["Loading"]</p>
}

@code {
  [Parameter]
  public string Topic { get; set; }
  [Parameter]
  public string Name { get; set; }

  private string ImgFile => $"img/{Topic}/{Name}";
  private string OverlayImgFile => $"img/{Topic}/ovl_{Name}";
  private string EditOverlayUrl => $"/editor/{Uri.EscapeDataString(Topic)}/{Uri.EscapeDataString(Name)}";
  private string CSI => _portrait ? "col-sm-6" : "col-sm-8";
  private string ColSizeImg => $"col-12 {CSI} d-flex justify-content-end";
  private string CST => _portrait ? "col-sm-6" : "col-sm-4";
  private string ColSizeTxt => $"col-12 {CST} justify-content-start";

  private string? _headline;
  private bool _portrait = false;

  private bool _showOverlay = false;
  private bool _hasOverlayImg = false;
  private OverlayData? _overlayData = null;

  protected override async Task OnInitializedAsync()
  {
    var src = await f2iDataService.GetStoryText(Topic, Name);

    (int width, int heigth) = await f2iDataService.GetImageFormat(Topic, Name);
    _portrait = width < heigth;

    _hasOverlayImg = await f2iDataService.OverlayExists(Topic, Name);
    _overlayData = await f2iDataService.GetOverlayData(Topic, Name);

    _headline = src.GetHeadline ();
  }

  private void ShowOverlayImage(MouseEventArgs args) => _showOverlay = true;

  private void HideOverlayImage() => _showOverlay = false;
}
