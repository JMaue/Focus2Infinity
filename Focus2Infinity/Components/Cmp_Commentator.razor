@using Focus2Infinity.Data
@using Focus2Infinity.Services
@inject IJSRuntime JSRuntime

@inject IStringLocalizer<SharedResource> L
@inject F2IDataService f2iDataService
@inject IEMailService f2iEmailService
@inject ICommentValidationService f2iCommentValidationService

<div class="mt-3">
  <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleConversation" aria-expanded="@showConversation">
    @L["Conversation"] <span class="ms-1" aria-hidden="true">@((showConversation ? "▴" : "▾"))</span>
  </button>
</div>

@if (showConversation)
{
  <div class="card mt-3 border bg-body text-body">
@*     <div class="card-header bg-secondary">@L["Conversation"]</div> *@
    <div class="card-body">
      @if (comments.Count == 0)
      {
        <div class="text-muted">@L["No comments yet."]</div>
      }
      else
      {
        @foreach (var c in comments)
        {
          var name = c.Name;
          var date = c.Date.ToString("g");
          var txt = c.Text;
          <div class="mb-3 pb-2 border-bottom">
            <div>
              <strong class="text-white">@name</strong> 
              <small class="text-muted">@date</small>
            </div>
            <div class="mt-1 text-light">@txt</div>
          </div>
        }
      }

      <hr />
      <EditForm Model="commentModel" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="row g-2">
          <div class="col-md-4">
            <InputText class="form-control" @bind-Value="commentModel.Name" placeholder="@L["Name"]" />
          </div>
          <div class="col-md-4">
            <InputText type="email" class="form-control" @bind-Value="commentModel.Email" placeholder="@L["E-mail"]" />
          </div>
          <div class="col-12">
            <InputTextArea class="form-control" @bind-Value="commentModel.Text" placeholder="@L["Comment"]" rows="3" />
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn" style="background-color:lightsteelblue; color:black" disabled="@submitting">@L["Submit"]</button>
          </div>
        </div>
      </EditForm>
    </div>
  </div>
}

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="commentToast" class="toast align-items-center border-0 @toastClass" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <strong>@toastTitle</strong><br />
        @toastMessage
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

@code {

  [Parameter]
  public string Topic { get; set; }

  [Parameter]
  public string Src { get; set; }

  private bool showConversation = false;
  private bool submitting = false;
  private List<CommentItem> comments = new();

  private CommentModel commentModel = new();

  private string toastTitle = "";
  private string toastMessage = "";
  private string toastClass = "";

  protected override async Task OnInitializedAsync()
  {
    comments = await f2iDataService.GetCommentHistory(Topic, Src);
  }

  private void ToggleConversation()
  {
    showConversation = !showConversation;
  }

  private async Task HandleSubmit()
  {
    if (string.IsNullOrWhiteSpace(commentModel.Name) || string.IsNullOrWhiteSpace(commentModel.Email) || string.IsNullOrWhiteSpace(commentModel.Text))
      return;

    try
    {
      submitting = true;

      //(bool isValid, string reason) = (false, "Test"); ; //await f2iCommentValidationService.IsValidComment(commentModel.Text);
      (bool isValid, string reason) = await f2iCommentValidationService.IsValidComment(commentModel.Text);

      var about = isValid ? $"New comment on {Topic}/{Src}" : $"Invalid comment on {Topic}/{Src}";
      var content = $"Name: {commentModel.Name}\n\nEmail: {commentModel.Email}\n\nMessage: {commentModel.Text}\n\nReason: {reason}";
      
      var commentItem = new CommentItem
      {
        Name = commentModel.Name,
        Email = commentModel.Email,
        Text = commentModel.Text,
        Date = DateTime.UtcNow,
        Reason = reason
      };
      
      if (isValid)
      {
        comments.Add(commentItem);
      }

      // send email notification
      await f2iEmailService.SendAsync("j.mauersberger@focustoinfinity.eu", about, content);

      // store comment
      await f2iDataService.AddComment(Topic, Src, commentItem, isValid);

      // start fresh
      commentModel = new CommentModel();

      // Show toast notification
      if (isValid)
      {
        toastTitle = L["Success"];
        toastMessage = L["Your comment has been submitted successfully."];
        toastClass = "bg-success text-white";
      }
      else
      {
        toastTitle = L["Rejected"];
        toastMessage = $"{L["Your comment has been rejected."]} {reason}";
        toastClass = "bg-danger text-white";
      }
      
      // Force UI update before showing toast
      StateHasChanged();
      await Task.Delay(100);
      
      await ShowToast();
    }
    finally
    {
      submitting = false;
    }
  }

  private async Task ShowToast()
  {
    await JSRuntime.InvokeVoidAsync("eval", @"
      (function() {
        var toastEl = document.getElementById('commentToast');
        if (toastEl && typeof bootstrap !== 'undefined') {
          var toast = new bootstrap.Toast(toastEl, { 
            autohide: true, 
            delay: 5000 
          });
          toast.show();
        } else {
          if (toastEl) {
             console.error('Toast element found');
          }
          else {
            console.error('Bootstrap not found');
          }
        }
      })();
    ");
  }

  private sealed class CommentModel
  {
    public string Name { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Text { get; set; } = string.Empty;
  }
}
