@using Focus2Infinity.Data
@using Focus2Infinity
@using System.Globalization
@using System.Net
@inject IStringLocalizer<SharedResource> L

@if (OverlayData != null)
{
  <svg style="@GetOverlay()">
    @* Lines *@
    @foreach (var line in OverlayData.Lines)
    {
      @if (line.UsePercentage)
      {
        <line x1="@SvgPct(line.X1)" y1="@SvgPct(line.Y1)"
              x2="@SvgPct(line.X2)" y2="@SvgPct(line.Y2)"
              stroke="@line.Color"
              stroke-width="@SvgNum(line.StrokeWidth)" />
      }
      else
      {
        <line x1="@SvgNum(line.X1)" y1="@SvgNum(line.Y1)"
              x2="@SvgNum(line.X2)" y2="@SvgNum(line.Y2)"
              stroke="@line.Color"
              stroke-width="1" />
      }
    }

    @* Circles *@
    @foreach (var circle in OverlayData.Circles)
    {
      @if (circle.UsePercentage)
      {
        <circle cx="@SvgPct(circle.Cx)" cy="@SvgPct(circle.Cy)"
                r="@SvgPct(circle.Radius)"
                stroke="@circle.Color"
                stroke-width="@SvgNum(circle.StrokeWidth)"
                fill="@(circle.Fill? circle.Color: "none")" />
      }
      else
      {
        <circle cx="@SvgNum(circle.Cx)" cy="@SvgNum(circle.Cy)"
                r="@SvgNum(circle.Radius)"
                stroke="@circle.Color"
                stroke-width="@SvgNum(circle.StrokeWidth)"
                fill="@(circle.Fill? circle.Color: "none")" />
      }
    }

    @* Text Labels *@
    @foreach (var text in OverlayData.Texts)
    {
      var displayText = !string.IsNullOrEmpty(text.TextKey)
      ? L[text.TextKey].Value
      : text.Text;

      @((MarkupString)GetTextElementHtml(text, displayText))
    }
  </svg>
}

@code {
  [Parameter]
  public OverlayData? OverlayData { get; set; }

  [Parameter]
  public bool ShowOverlay { get; set; }

  private string GetOverlay()
  {
    var style = "position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; will-change: opacity; transition: opacity 0.7s ease-in-out;";
    if (ShowOverlay)
      return $"{style} opacity: 1;";

    return $"{style} opacity: 0;";
  }

  private string GetTextElementHtml(OverlayText text, string displayText)
  {
    var x = text.UsePercentage ? SvgPct(text.X) : SvgNum(text.X);
    var y = text.UsePercentage ? SvgPct(text.Y) : SvgNum(text.Y);
    var escapedText = WebUtility.HtmlEncode(displayText);

    return $"<text x=\"{x}\" y=\"{y}\" fill=\"{text.Color}\" font-size=\"{text.FontSize}\" font-family=\"{text.FontFamily}\" dominant-baseline=\"text-before-edge\" text-anchor=\"start\">{escapedText}</text>";
  }

  private static string SvgPct(double v) => v.ToString(CultureInfo.InvariantCulture) + "%";
  private static string SvgNum(double v) => v.ToString(CultureInfo.InvariantCulture);
}
